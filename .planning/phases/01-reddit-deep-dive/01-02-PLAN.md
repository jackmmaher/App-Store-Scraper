---
phase: 01-reddit-deep-dive
plan: 02
type: execute
---

<objective>
Create database tables and Supabase CRUD operations for Reddit analysis storage.

Purpose: Enable persistence of Reddit analysis results and user solution annotations.
Output: Working database tables with CRUD functions in lib/supabase.ts
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./01-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-reddit-deep-dive/01-01-SUMMARY.md
@docs/plans/2026-02-01-reddit-deep-dive-design.md

Relevant source files:
@lib/supabase.ts
@lib/reddit/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase migration for reddit_analyses table</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_reddit_analyses.sql</files>
  <action>
Create SQL migration file (use current timestamp for filename):

```sql
-- Reddit Deep Dive Analysis Storage
CREATE TABLE IF NOT EXISTS reddit_analyses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  competitor_id UUID NOT NULL,
  search_config JSONB NOT NULL,
  unmet_needs JSONB NOT NULL DEFAULT '[]',
  trends JSONB NOT NULL DEFAULT '{}',
  sentiment JSONB NOT NULL DEFAULT '{}',
  language_patterns TEXT[] DEFAULT '{}',
  top_subreddits JSONB DEFAULT '[]',
  raw_data JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for competitor lookups
CREATE INDEX IF NOT EXISTS idx_reddit_analyses_competitor_id ON reddit_analyses(competitor_id);

-- Solution annotations for unmet needs
CREATE TABLE IF NOT EXISTS unmet_need_solutions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  reddit_analysis_id UUID REFERENCES reddit_analyses(id) ON DELETE CASCADE,
  need_id TEXT NOT NULL,
  solution_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(reddit_analysis_id, need_id)
);

-- Index for analysis lookups
CREATE INDEX IF NOT EXISTS idx_unmet_need_solutions_analysis ON unmet_need_solutions(reddit_analysis_id);

-- Add reddit_analysis_id to linked_competitors if not exists
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'linked_competitors' AND column_name = 'reddit_analysis_id'
  ) THEN
    ALTER TABLE linked_competitors ADD COLUMN reddit_analysis_id UUID REFERENCES reddit_analyses(id);
  END IF;
END $$;

-- RLS policies (match existing patterns)
ALTER TABLE reddit_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE unmet_need_solutions ENABLE ROW LEVEL SECURITY;

-- Allow all operations for authenticated users (simple auth model)
CREATE POLICY "Allow all for reddit_analyses" ON reddit_analyses FOR ALL USING (true);
CREATE POLICY "Allow all for unmet_need_solutions" ON unmet_need_solutions FOR ALL USING (true);
```

Check existing migrations folder structure first. If no migrations folder exists, create the SQL as a standalone file and note that it needs manual execution.
  </action>
  <verify>SQL syntax is valid. If Supabase CLI available: `supabase db diff` shows expected changes</verify>
  <done>Migration file created with proper table structure and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add Reddit CRUD operations to Supabase client</name>
  <files>lib/supabase.ts</files>
  <action>
Add functions to lib/supabase.ts following existing patterns:

```typescript
// Reddit Analysis CRUD
export async function createRedditAnalysis(
  competitorId: string,
  searchConfig: RedditSearchConfig,
  result: Omit<RedditAnalysisResult, 'id' | 'competitorId' | 'searchConfig' | 'createdAt'>
): Promise<RedditAnalysisResult | null>

export async function getRedditAnalysis(
  competitorId: string
): Promise<RedditAnalysisResult | null>

export async function getRedditAnalysisById(
  analysisId: string
): Promise<RedditAnalysisResult | null>

// Solution annotations
export async function saveUnmetNeedSolutions(
  analysisId: string,
  solutions: Array<{ needId: string; notes: string }>
): Promise<boolean>

export async function getUnmetNeedSolutions(
  analysisId: string
): Promise<Array<{ needId: string; notes: string }>>

// Link analysis to competitor
export async function linkRedditAnalysisToCompetitor(
  competitorId: string,
  analysisId: string
): Promise<boolean>
```

Import RedditSearchConfig and RedditAnalysisResult from lib/reddit/types.ts.
Use service key client (supabaseAdmin) for writes. Follow existing error handling patterns.
  </action>
  <verify>TypeScript compiles without errors. Functions can be imported from lib/supabase</verify>
  <done>All CRUD functions implemented and exported</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Migration SQL is syntactically valid
- [ ] CRUD functions exported from lib/supabase.ts
- [ ] Types properly imported in supabase.ts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Database operations ready for use by API endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/01-reddit-deep-dive/01-02-SUMMARY.md`
</output>
